#!/bin/bash

## RNA Research Pipeline
## Copyleft 2017 Institut Curie
## Author(s): Nicolas Servant
## Contact: nicolas.servant@curie.fr
## This software is distributed without any guarantee under the terms of the GNU General
## Public License, either Version 2, June 1991 or Version 3, June 2007.

SOFT="RNApip"
VERSION="0.2.4"

function usage {
    echo -e "usage : $SOFT -f FORWARD -o OUTPUT -c CONFIG [-r REVERSE][-s SAMPLE_ID] [-d] [-h] [-v]"
    echo -e "Use option -h|--help for more information"
}

function help {
    usage;
    echo
    echo "$SOFT $VERSION"
    echo "---------------"
    echo "OPTIONS"
    echo
    echo "   -f|--forward INPUT: input forward fastq file"
    echo "   -o|--output OUTPUT: output folder"
    echo "   -c|--conf CONFIG: configuration file for RNA processing"
    echo "   [-r|--reverse INPUT]: input reverse fastq file"
    echo "   [-s|--sample ID]: sample ID"
    echo "   [-d|--dryrun]: dry run mode"
    echo "   [-h|--help]: help"
    echo "   [-v|--version]: version"
    exit;
}

function version {
    echo -e "$SOFT version $VERSION"
    exit
}

function set_dry_run {
    echo -e "Dry run mode"
    DRY_RUN=1
}

function opts_error {
    echo -e "Error : invalid parameters !" >&2
    echo -e "Use $SOFT -h for help"
    exit
}

if [ $# -lt 1 ]
then
    usage
    exit
fi

# Transform long options to short ones
for arg in "$@"; do
  shift
  case "$arg" in
      "--reverse") set -- "$@" "-r" ;;
      "--forward") set -- "$@" "-f" ;;
      "--output") set -- "$@" "-o" ;;
      "--conf")   set -- "$@" "-c" ;;
      "--sample")   set -- "$@" "-s" ;;
      "--dryrun")   set -- "$@" "-d" ;;
      "--help")   set -- "$@" "-h" ;;
      "--version")   set -- "$@" "-v" ;;
      *)        set -- "$@" "$arg"
  esac
done

while getopts "f:r:o:c:s:hvd" OPT
do
    case $OPT in
        f) FORWARD=$OPTARG;;
	r) REVERSE=$OPTARG;;
	o) ODIR=$OPTARG;;
	c) CONF=$OPTARG;;
	s) SAMPLE_ID=$OPTARG;;
	d) set_dry_run ;;
	v) version ;;
	h) help ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    usage
	     exit 1
	     ;;
	:)
	    echo "Option -$OPTARG requires an argument." >&2
	    usage
	    exit 1
	    ;;
    esac
done


if [[ -z $FORWARD || -z $ODIR || -z $CONF ]]; then
    usage
    exit
fi

## Set PATHS
BIN_PATH=`dirname $0`
ABS_BIN_PATH=`cd "$BIN_PATH"; pwd`
SCRIPTS_PATH="$ABS_BIN_PATH/../scripts/"

## Load functions file
. $SCRIPTS_PATH/utils.inc.sh
. $SCRIPTS_PATH/rna.inc.sh

#####################
## Init log file
#####################


echo -e "--------------------"
echo -e "Running ${SOFT} v${VERSION}"
when=$(date +%Y-%m-%d)
echo -e "Date: ${when}"
where=$(hostname)
echo -e "Host: ${where}"
echo -e "Input: ${FORWARD} ${REVERSE}"
echo -e "Ouput: ${ODIR}"
echo -e "Config: ${CONF}"
if [[ ! -z $SAMPLE_ID ]]; then
    echo -e "SampleID: ${SAMPLE_ID}"
fi
echo -e "--------------------"
echo 

#####################
## Check Config file
#####################

if [ ! -z "$CONF" ]; then
    CONF=`abspath $CONF`
    if [ -e "$CONF" ]; then
        read_config $CONF
    else
        echo "Error - config file '$CONF' not found"
        exit 1
    fi
fi

## Check mapping indexes
echo -n "Checking index files ... "
if [ ${MAPPING_TOOL} == "STAR" ]; then
    file_exists ${STAR_INDEX}
elif [ ${MAPPING_TOOL} == "TOPHAT2" ]; then
    file_exists $(dirname ${TOPHAT2_INDEX})
fi
echo -e "OK"

## Annotation
echo -n "Checking annotation files ... "
if [ ! -z ${R_RNA_FASTA} ]; then file_exists ${R_RNA_FASTA}; fi
if [ ! -z ${TRANSCRIPTS_GTF} ]; then file_exists ${TRANSCRIPTS_GTF}; fi
if [ ! -z ${GENE_BED} ]; then file_exists ${GENE_BED}; fi
echo -e "OK"
echo

## Create output directory
mkdir -p ${ODIR}
LOGDIR=${ODIR}/logs
mkdir -p ${LOGDIR}

###################                                                                                                                                                                                                                          
## Prepare outputs                                                                                                                                                                                                                           
###################                                                                                                                                                                                                                          

echo -e "Init workflow ..."
echo
PREFIX=$(get_fastq_prefix ${FORWARD})
bash ${SCRIPTS_PATH}/makeOutputList.sh -c ${CONF} -p ${PREFIX} -o ${ODIR}

###################
## WORFLOW
###################

## FASTQC
if [ ${RUN_FASTQC} == 1 ]; then
    fastqc_func "${FORWARD} ${REVERSE}" ${ODIR} ${LOGDIR}
fi

## Rseqc - infer experiment
if [ -z $STRANDED ]; then
    rseqc_func "${FORWARD} ${REVERSE}" ${ODIR} ${LOGDIR}
    rseq_output=$(get_fastq_prefix ${FORWARD}).rseqc
    libtype=$(parse_rseqc_output ${ODIR}/strand_check/${rseq_output})
    
    if [[ ${libtype} == "undetermined" ]]; then
	die "Cannot determined library type. Please set the STRANDED parameter in the configuration file"
    else
	echo -e "Info: RSeqQC detected stranded='${libtype}' ..."
	echo -e
	STRANDED=${libtype}
    fi
else
    mkdir -p ${ODIR}/strand_check
    echo -e "Info: STRANDED parameter detected - skipping Rseqqc ..."
    echo -e "Info: stranded='$STRANDED' ..."
fi

## Save STANDED parameter
echo -e "STRANDED=$STRANDED" > ${ODIR}/strand_check/strandness.info

## Mapping - remove rRNA
if [ ! -z ${BOWTIE_RRNA_INDEX} ]; then
    file_exists $(dirname ${BOWTIE_RRNA_INDEX})
    rRNA_mapping_func "${FORWARD} ${REVERSE}" ${ODIR} ${LOGDIR}
    R_RNA_BAM=${ODIR}/rRNA_mapping/$(basename ${FORWARD} | sed -e 's/[\._]*R*[12]*.fastq\(.gz\)*/.bam/')

    # Rename unmapped read output (bowtie automatically adds _1 and _2 for PE reads
    if [[ -z ${REVERSE} ]]; then
	FORWARD_RRNA=${ODIR}/rRNA_mapping/$(basename ${FORWARD} | sed -e 's/[\._]*R*[12]*.fastq/_norRNA.fastq/')
    else
	FORWARD_RRNA=${ODIR}/rRNA_mapping/$(basename ${FORWARD} | sed -e 's/[\._]*R*[12]*.fastq/_norRNA_1.fastq/')
	REVERSE_RRNA=${ODIR}/rRNA_mapping/$(basename ${FORWARD_RRNA} | sed -e 's/_1.fastq/_2.fastq/')
    fi
else
    echo -e "Info: BOWTIE_RRNA_INDEX not set - skipping rRNA mapping ..."
    echo
    FORWARD_RRNA=${FORWARD}
    REVERSE_RRNA=${REVERSE}
fi

## Mapping on genome
if [ ${MAPPING_TOOL} == "TOPHAT2" ]; then
    MAPPING_OPTS=${TOPHAT2_OPTS}
    MAPPING_IDNEX=${TOPHAT2_INDEX}
    tophat2_func "${FORWARD_RRNA} ${REVERSE_RRNA}" ${ODIR} ${LOGDIR}   

elif [ ${MAPPING_TOOL} == "STAR" ]; then
    MAPPING_OPTS=${STAR_OPTS}
    MAPPING_IDNEX=${STAR_INDEX}
    star_func "${FORWARD_RRNA} ${REVERSE_RRNA}" ${ODIR} ${LOGDIR}
   
else
    die "Mapping tool not supported !"
fi

BAM_INPUT=${ODIR}/mapping/$(basename $FORWARD_RRNA | sed -e 's/[\._]*R*[12]*.fastq\(.gz\)*/.bam/')

## index BAM file
bamindex_func ${BAM_INPUT} ${LOGDIR}

## Run Saturation curves with preseq
preseq_func ${BAM_INPUT} ${ODIR} ${LOGDIR}

## Check number of duplicates
markdup ${BAM_INPUT} ${LOGDIR}

##  Count per transcripts
if [ ${COUNT_TOOL} == "HTSEQ" ]; then
    htseq_func ${BAM_INPUT} ${ODIR} ${LOGDIR}

elif [ ${COUNT_TOOL} == "FEATURECOUNTS" ]; then
    featurecounts_func ${BAM_INPUT} ${ODIR} ${LOGDIR}

elif [[ ${COUNT_TOOL} == "STAR" && ${MAPPING_TOOL} == "STAR" ]]; then
    starcounts_func ${BAM_INPUT} ${ODIR} ${LOGDIR}

elif [[ ${COUNT_TOOL} == "STAR" && ${MAPPING_TOOL} != "STAR" ]]; then
    die "Invalid parameter - STAR cannot be used !"

elif [[ ${COUNT_TOOL} != "STAR" ]]; then
    die "$COUNT_TOOL is not supported !"
fi

## QC/Stats
mapping_stat "${FORWARD} ${REVERSE}" ${CONF} ${BAM_INPUT} ${ODIR} ${LOGDIR} ${R_RNA_BAM}
when=$(date +%Y-%m-%d)

## Check output files
echo -e "Checking output files ..."
check_output_files ${ODIR} ${ODIR}/logs/output_list.tsv

echo
echo -e "Completed on ${when}! Results are available in ${ODIR}"
echo

